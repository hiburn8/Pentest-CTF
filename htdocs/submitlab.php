<?php 

session_start();

if (!isset($_SESSION["username"])){
    $_SESSION["redirectURL"] = "submitlab.php";
    header('Location: auth.php');
    die();
}

require_once("mysqli_connect.php");
require_once('header.php');
/*

echo '<h2>Stats</h2>';
if (isset($_SESSION["username"])){
    echo '<h3>Personal</3>';

}
else{
	echo "login to see personal stats";
}
*/
/*
function catagorycolor($cat) {
    
        switch ($cat) {
        case 'Web': return '1693A5'; break;
        case 'Mobile': return '025D8C'; break;
        case 'Reversing': return 'BAE4E5'; break;
        case 'Forensics': return '02779E'; break;
        case 'Programming': return 'BAE4E9'; break;
        
    }
}
*/

$userdata_get = "SELECT category, count(category) AS amount, SUM(difficulty) AS availablepoints, SUM(difficulty)/count(category) AS averagepoints from `labs` GROUP BY category";
$labdata = $dbc->query($userdata_get);

function totallabsdata($dbc, $labdata){
	mysqli_data_seek($labdata, 0);
	while ($row = $labdata->fetch_array(MYSQLI_ASSOC)){
		echo "['" . $row["category"] . "', " . $row["amount"] . "],";
	}
}


function availablepointsdata($dbc, $labdata){
	mysqli_data_seek($labdata, 0);
	while ($row = $labdata->fetch_array(MYSQLI_ASSOC)){
		echo "['" . $row["category"] . "', " . $row["availablepoints"] . "],";
	}
}

function averagepointsdata($dbc, $labdata){
	mysqli_data_seek($labdata, 0);
	while ($row = $labdata->fetch_array(MYSQLI_ASSOC)){
		echo "['" . $row["category"] . "', " . $row["averagepoints"] . "],";
	}
}

$authordata_get = "SELECT users.username, count(category) AS amount, SUM(difficulty) AS availablepoints, SUM(difficulty)/count(category) AS averagepoints from `labs` INNER JOIN users ON labs.authorID=users.userID GROUP BY authorID";
$authordata = $dbc->query($authordata_get);


function authortotallabsdata($dbc, $authordata){
  mysqli_data_seek($authordata, 0);
  while ($row = $authordata->fetch_array(MYSQLI_ASSOC)){
    echo "['" . $row["username"] . "', " . $row["amount"] . "],";
  }
}


function authoravailablepointsdata($dbc, $authordata){
  mysqli_data_seek($authordata, 0);
  while ($row = $authordata->fetch_array(MYSQLI_ASSOC)){
    echo "['" . $row["username"] . "', " . $row["availablepoints"] . "],";
  }
}

function authoraveragepointsdata($dbc, $authordata){
  mysqli_data_seek($authordata, 0);
  while ($row = $authordata->fetch_array(MYSQLI_ASSOC)){
    echo "['" . $row["username"] . "', " . $row["averagepoints"] . "],";
  }
}

?>


<h2>Submit a lab</h2>

<h3>Information for Lab makers</h3>
<p>While we encourage you to make any lab you wish, ideally we would have a good balance of labs in all categories and of all difficulties. 
  Take a look at the stats below to get an idea of where we most need new labs.
  <br>
  Please email an admin to request a submit token and your request will be dealt with shortly: <a HREF="mailto:webmaster@example.com?subject=CTF submit-lab token request&body=give <?php $_SESSION['username'] ?> one">gimme one</a>;
</p>
<fieldset>
  <legend>Category Stats:</legend>
  <div id="piechart" class="piechart" style="width: 385px; height: 238px;"></div>
  <script >
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Total Labs in each Category'],
       		<?php echo totallabsdata($dbc, $labdata); ?>
        ]);

        var options = {
          title: 'Total Labs in each Category',
          colors: ['#025D8C', '#1693A5', '#BAE4E5', '#02779E', '#BAE4E9'],
          pieSliceText: 'value',
          is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);
      }
</script>
<div id="piechart2" class="piechart" style="width: 385px; height: 238px;"></div>
  <script >
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Total Points in each Category'],
       		<?php echo availablepointsdata($dbc, $labdata); ?>
        ]);

        var options = {
          title: 'Total Points in each Category',
          colors: ['#025D8C', '#1693A5', '#BAE4E5', '#02779E', '#BAE4E9'],
          pieSliceText: 'value',
          is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart2'));
        chart.draw(data, options);
      }
</script>
<div id="piechart3" class="piechart" style="width: 385px; height: 238px;"></div>
  <script >
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Average Points per Lab in each Category'],
       		<?php echo averagepointsdata($dbc, $labdata); ?>
        ]);

        var options = {
          title: 'Average Points per Lab in each Category',
          colors: ['#025D8C', '#1693A5', '#BAE4E5', '#02779E', '#BAE4E9'],
          pieSliceText: 'value',
          is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart3'));
        chart.draw(data, options);
      }
</script>
</fieldset>

<fieldset>
  <legend>Author Stats:</legend>
  <div id="piechart4" class="piechart" style="width: 385px; height: 238px;"></div>
  <script >
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Total Labs from each Author'],
          <?php echo authortotallabsdata($dbc, $authordata); ?>
        ]);

        var options = {
          title: 'Total Labs from each Author',
          colors: ['#025D8C', '#1693A5', '#BAE4E5', '#02779E', '#BAE4E9'],
          pieSliceText: 'value',
          is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart4'));
        chart.draw(data, options);
      }
</script>
<div id="piechart5" class="piechart" style="width: 385px; height: 238px;"></div>
  <script >
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Total Points from each Author'],
          <?php echo authoravailablepointsdata($dbc, $authordata); ?>
        ]);

        var options = {
          title: 'Total Points from each Author',
          colors: ['#025D8C', '#1693A5', '#BAE4E5', '#02779E', '#BAE4E9'],
          pieSliceText: 'value',
          is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart5'));
        chart.draw(data, options);
      }
</script>
<div id="piechart6" class="piechart" style="width: 385px; height: 238px;"></div>
  <script >
      google.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Task', 'Average Points per Lab from each Author'],
          <?php echo authoraveragepointsdata($dbc, $authordata); ?>
        ]);

        var options = {
          title: 'Average Points per Lab from each Author',
          colors: ['#025D8C', '#1693A5', '#BAE4E5', '#02779E', '#BAE4E9'],
          pieSliceText: 'value',
          is3D: true
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart6'));
        chart.draw(data, options);
      }
</script>
</fieldset>


<?php include 'footer.php';?>
