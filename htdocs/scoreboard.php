<?php

session_start();
require_once("mysqli_connect.php");
require_once('header.php');
require_once('functions.php');

$flags = 0;
$badges = '';

//(get username lab and how_long_it_took)SELECT users.username, labs.labname, (UNIX_TIMESTAMP(pwns.completed) - UNIX_TIMESTAMP(labs.created))/60/60/24 AS timetaken FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID ORDER BY timetaken ASC

//(get commission data) SELECT users.username, TRUNCATE(sum(labs.difficulty/10), 1) AS commission FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users ON users.userID=labs.authorID group by authorID


function onlinestatus($username){
	if (isset($_SESSION["username"]) && $_SESSION["username"] == $username){
	    return '<img src="badges/status_online.png" title="you are online">';
	}
}

function top3orlast($pos, $flags, $rows){

	$badges = '';

	if (isset($_SESSION["position"])){

		if ($pos < $_SESSION["position"]){
	    	$badges .= '<img src="badges/bullet_arrow_down.png">';
		}
		elseif ($pos > $_SESSION["position"]){
	    	$badges .= '<img src="badges/bullet_arrow_up.png">';
		}
		else{
			$_SESSION["position"] = $pos;
		}
	}
	switch ($pos) {
	    case 1: $badges .= '<img src="badges/award_star_gold_1.png" title="you are 1st!">'; break;
	    case 2: $badges .= '<img src="badges/award_star_silver_2.png" title="you are 2nd!">'; break;
	    case 3: $badges .= '<img src="badges/award_star_bronze_3.png" title="you are 3rd!">'; break;
	}
	switch ($flags) {
	    case 1:
	        $badges .= '<img src="badges/rosette.png" title="you earned your first flag!">';
	        break;
	}
	if ($pos == $rows){
			$badges .= '<img src="badges/poop-emoticon.png" title="oh dear. youre last">';
	}
	//echo $flags;
	if (!empty($badges)){
		return $badges;
	}
}

//$userdata_get = "SELECT users.username, COUNT(users.username) as count, users.points FROM `pwns` INNER JOIN users ON users.userID=pwns.userID GROUP BY username ORDER BY users.points DESC";

$userdata_get = "SELECT users.username, users.userID, COUNT(pwns.userID) AS flags, SUM(labs.difficulty) as sumDifficulty, registered FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID GROUP BY pwns.userID ORDER BY sumDifficulty DESC, flags DESC, users.registered DESC, username";
$usrrlt = $dbc->query($userdata_get);
?>

<h2>Scoreboard<a href="#" id="ajax-refresh"><img src="badges/refresh.png"></a></h2>



<table class="scoreboard">
<thead> 
<tr>
<td><b>Position</b></td>
<td><b>User</b></td>
<td><b>Points</b></td>
<td><b>Flags</b></td>
<td><b>Registered</b></td>
</tr>
</thead> 
<tbody> 
<?php
       
$pos = 1;
while( $row = $usrrlt->fetch_assoc()){
	echo '<tr>';
	echo '<td>' . $pos . top3orlast($pos, $row["flags"], $usrrlt->num_rows) . '</td>';
	echo '<td><a href="user.php?id=' . $row["userID"] . '">' . $row["username"] . '</a>' . onlinestatus($row["username"]) . '</td>';
	echo '<td>' . $row["sumDifficulty"] .'</td>';
	echo '<td>' . $row["flags"] . '</td>';
	echo '<td>' . timeBetween(strtotime($row["registered"]),-1) . ' ago' . '</td>';
	echo '</tr>';
$pos += 1;
}
echo '</tbody> ';
echo '</table>';
echo '</div>';
?>


<script>
    $('table').tablesorter({
    sortMultiSortKey: "shiftKey",
});
</script>


<?php
/*function getscoredata($dbc){

$userdata_get = "SELECT users.username, COUNT(pwns.userID) AS flags, SUM(labs.difficulty) as sumDifficulty, registered FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID GROUP BY pwns.userID ORDER BY sumDifficulty DESC";
$usrrlt = $dbc->query($userdata_get);
$pos = 1;
while( $row = $usrrlt->fetch_assoc()){

	echo "['" . $pos . "', '" . $row["username"] . "' , '" . timeBetween(strtotime($row["registered"]),-1) . "' , '" . $row["flags"] . "' , '" . $row["sumDifficulty"] . "'],";
	$pos += 1;
}
}*/
?>
<script type="text/javascript">
$(function() {

  $("#ajax-refresh").click(function() {

    $.get("scoreboard_ajax.php", function(html) {

      // append the "ajax'd" data to the table body
      $("table tbody").text(null)
      $("table tbody").append(html);

      // let the plugin know that we made a update
      // the resort flag set to anything BUT false (no quotes) will trigger an automatic
      // table resort using the current sort
      var resort = true;
      $("table").trigger("update", [resort]);

      // triggering the "update" function will resort the table using the current sort; since version 2.0.14
      // use the following code to change the sort; set sorting column and direction, this will sort on the first and third column
      // var sorting = [[2,1],[0,0]];
      // $("table").trigger("sorton", [sorting]);

    });

    return false;
  });

});
</script>



<!-- OLD GOOGLE CORECHART TABLE
<div id="table_div"></div>
   <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["table"]});
      google.setOnLoadCallback(drawTable);

      function drawTable() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Position');
        data.addColumn('string', 'Username');
        data.addColumn('string', 'Registered');
        data.addColumn('string', 'Flags');
        data.addColumn('string', 'Points');
        data.addRows([
	  <?php //getscoredata($dbc); ?>
        ]);

        var table = new google.visualization.Table(document.getElementById('table_div'));

        table.draw(data, {showRowNumber: true});
      }
</script>-->
<?php include 'footer.php';?>
