<?php

session_start();
require_once("mysqli_connect.php");
require_once('header.php');
require_once('functions.php');


//(GET LABS ALL USERS HAVE DONE) SELECT labs.labname, users.username FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID ORDER BY users.username


//HonorRoll Stuff
$completiondata_get = "SELECT labs.labname, users.username, (UNIX_TIMESTAMP(pwns.completed) - UNIX_TIMESTAMP(labs.created))/60/60/24 AS timetaken, pwns.completed, users.birthday FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID ORDER BY pwns.completed";
    $completedrlt = $dbc->query($completiondata_get);

    $honorRollarray = array();
    while( $row = $completedrlt->fetch_assoc()){
    //echo $row["labname"] . $row["username"];
    $honorRollarray[] = $row;       
    }
  
function honorRoll($array, $labname){
    $string = "";
    $last = count($array) - 1;

    $counter = 1;
    foreach ($array as $i => $row){
        $isFirst = ($i == 0);
        $isLast = ($i == $last);
        //echo $row['labname'] . $row['username'];
        
        if ($row['labname'] == $labname){

            $string .= "<li>" . $row['username'];

            //echo date('a', strtotime($row['completeDate']));            
            //              switch ($counter) {
            //                  case 1: $string .= '<img src="badges/medal_gold_1.png">' . $row['username'] . '<br>'; break;
            //                  case 2: $string .= '<img src="badges/medal_silver_2.png">' . $row['username'] . '<br>'; break;
            //                  case 3: $string .= '<img src="badges/medal_bronze_3.png">' . $row['username'] . '<br>'; break;
            //                  default: $string .= $row['username'] . '<br>';
            //              }

            //do the lab in less than a day?
            if ($row['timetaken'] <= 1){
                $string .= '<img src="badges/lightning.png">';
            }
            //check if you did the lab on Christmas!
            if (date('m-d', strtotime($row['completed'])) == "12-25"){
                $string .= '<img src="badges/santa-hat.png">';
            }
            //working on your birthday?
            if (date('m-d', strtotime($row['completed'])) == date('m-d', strtotime($row['birthday']))){
                $string .= '<img src="badges/cake.png">';
            }
            //burning the midnight oil?
            if (date('D', strtotime($row['completed'])) == "Fri" && date('H', strtotime($row['completed'])) > 22){
                $string .= '<img src="badges/drink.png">';
            }

            $string .= '</li>';
        }
        $counter ++;
    }

    return $string;
}



if (isset($_SESSION["username"])){
    $labs = getlabsfromUsername($dbc, $_SESSION["username"]);
    //var_dump($labs);
}


// get username/userID data
$userdata_get = "SELECT userID, username FROM users";
$usernames = $dbc->query($userdata_get);
$userIDs = array();

while ($row = $usernames->fetch_array(MYSQLI_ASSOC)){
$userIDs[$row["userID"]] = $row["username"];
}

function haveidonethislab($labs, $labname){
    if (in_array($labname, $labs)) {return 1;}
    else { return 0;}
}

function isnew($created, $nowtime){
    $twoweeks = 1209600;
    if (($nowtime - strtotime($created)) < $twoweeks) {
        return '<img src="badges/new.png" title="This lab was made in the last 2 weeks">';
    }
}

function isdown($status){
    if ($status != 0) {
        return '<img src="badges/error.png" title="This lab is down for some reason :(">';
    }
}

?>

<script src="misc.js"></script>
<script>
var easter_egg = new Konami();
easter_egg.load('data:text/html;base64,bm90aGluZyB0byBzZWUgaGVyZS4gbW92ZSBhbG9uZyA8IS0tIkk0bTdoZUVHR200L1wvIi0tPg==')
</script>

<h2>Labs</h2>
	<div id="accordion">

	<?php

    $labdata_get = "SELECT labname, category, difficulty, labdescription, url, created, authorID, status FROM labs ORDER BY difficulty DESC, created";
    $labrlt = $dbc->query($labdata_get);

    $nowtime = time();
	while( $row = $labrlt->fetch_assoc()){

	echo '<h3>';
    if (isset($labs) && haveidonethislab($labs, $row["labname"])){
        echo isdown($row["status"]) . ' ' . categoryIcon($row["category"]) . ' <strike>' . $row["labname"] . ' - (' . dif2txt($row["difficulty"]) . ' / ' . $row["difficulty"] . ' Points)</strike>' . isnew($row["created"], $nowtime) . ' <img src="badges/tick.png">';
    }
    else{
        echo isdown($row["status"]) . ' ' . categoryIcon($row["category"]) . ' ' . $row["labname"] . ' - (' . dif2txt($row["difficulty"]) . ' / ' . $row["difficulty"] . ' Points)' . isnew($row["created"], $nowtime);
    }
    echo '</h3>';
	echo '<div>
    <b>Category:</b> ' . $row["category"] . '<br>
    <b>Location:</b> <a href="' . $row["url"] . '">' . $row["url"] . '</a><br> 
    <b>Author:</b> ' . $userIDs[$row["authorID"]] . '<br>
    <b>Description:</b> ' . $row["labdescription"] . '<br>';
    $honorString = honorRoll($honorRollarray, $row["labname"]);
    if (!empty($honorString)){
        echo '<b>Honor Roll:</b><ol>' . $honorString . '</ol>';
    }
    echo '</div>';

	}
	echo '</div>'; 
?>
<script>
  $(function() {
    $( "#accordion" ).accordion();
  });
  </script>


<?php include 'footer.php';?>