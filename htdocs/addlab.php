<?php require_once("mysqli_connect.php");

include 'header.php';


if (isset($_GET['token'])){
	if (preg_match('/^\{?[A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}\}?$/', $_GET['token'])){

		echo '
<h2>Add Lab</h2>

		<form action="' . $_SERVER['PHP_SELF'] . '" method="post" enctype="multipart/form-data";>
			<table class="submit";>
								


				<tr>
					<td>Lab name:</td>
					<td><input type=text name="labname" value=""></input></td>
				</tr>
				<tr>
					<td>Description:</td>
					<td><input type=text name="labdescription" value=""></input></td>
				</tr>
				<tr>
				<td>Category</td>
				<td>
					<select name="category">
					<option value="web">Web</option>
					<option value="mobile">Mobile</option>
					<option value="forensics">Forensics</option>
					</select>
				</td>
				<tr>
				<td>Difficulty</td>
				<td>
					<select name="difficulty">
					<option value="extreme">Extreme</option>
					<option value="hard">Hard</option>
					<option value="medium">Medium</option>
					<option value="easy">Easy</option>
					<option value="trivial">Trivial</option>
					</select>
				</td>
				<tr>
					<td>URL:</td>
					<td><input type=text name="url" value=""></input></td>
				</tr>

				<td>
				<tr>
					<td>Flag:</td>
					<td><input type=text name="flag" value=""></input></td>
				</tr>
				</tr>

				<tr>
					<td colspan="2">
						<input type="hidden" name="token" value="' . $_GET['token'] . '">
						<input type="submit" value="Submit" />
					</td>
					
				</tr>
			</table>
		</form>
';
	}
	else{
		echo "not a valid token";
	}
}
else{
	if (!isset($_POST['token'])){
		echo 'please email an admin to request an add-lab token and someone will verify your request shortly: <a HREF="mailto:webmaster@example.com?subject=CTF add-lab request&body=gimme one">gimme one</a>';
	}
}



if (isset($_POST['token'])){
	//copy = "INSERT INTO table (a, b, c) VALUES (NOW(),now() + interval 14 day, $var_for_c)";
	//SELECT completed, completed + interval 14 day FROM pwns

	if (preg_match('/^\{?[A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}\}?$/', $_POST['token'])){
	 //if (1 == 354){

		 if ($stmt = $dbc->prepare("SELECT * FROM tokens WHERE value = ? AND page = 'addlab.php' AND isburned = 'no' AND expires > NOW()")) {
		        
		        $stmt->bind_param('s', $_POST['token']);
		        $stmt->execute();   // Execute the prepared query.
		        $stmt->store_result();


		       if ($stmt->num_rows == 1) {
		            // If some labs exists get variables from result.
		            checkinput($dbc);
		        }
		        else{
		        	echo 'no';
		        }
		        
		}
		else {
		    return false;
		}
    }
    else {
        return 'database error';
    }
}




function checkinput($dbc){
				if (isset($_POST['labname']) && isset($_POST['category']) && isset($_POST['labdescription']) && isset($_POST['url']) && isset($_POST['flag']) && isset($_POST['difficulty'])){
            		$ln = $_POST['labname'];
					$cat = $_POST['category'];
					$ldesc = $_POST['labdescription'];
					$url = $_POST['url'];
					$f = $_POST['flag'];
					$diff = $_POST['difficulty'];

			
					if (burntoken($dbc, $_POST['token'])){
						add_lab($dbc, $ln, $cat, $ldesc, $url, $f, $diff);
					}

					//	if (strlen($username) < 4 || strlen($username) > 30{
					//	
					//	err ++;
					//	echo 'username must be between 4 and 30 characters';
					//	}
				}    	
		    	else{
		    		echo "missing data";
		    	}
		    }
	    

function add_lab($dbc, $ln, $cat, $ldesc, $url, $f, $diff ) {
 		$query = "INSERT INTO `labs` (`labname`, `category`, `labdescription`, `url`, `flag`, `difficulty`) VALUES (?, ?, ?, ?, ?, ?);";

        $stmt = mysqli_prepare($dbc, $query);
 
        mysqli_stmt_bind_param($stmt, 'ssssss', $ln, $cat, $ldesc, $url, $f, $diff);
 
        mysqli_stmt_execute($stmt);
     
        $affected_rows = mysqli_stmt_affected_rows($stmt);

            if($affected_rows == 1){
                 
                echo 'Lab successfully added';
                //mysqli_stmt_close($stmt);
                //mysqli_close($dbc);
                
            } 
            else{     
                echo 'Error Occurred<br />';
                echo mysqli_error($dbc);
                //mysqli_stmt_close($stmt);
                //mysqli_close($dbc);
               
            }
}

function burntoken($dbc, $token){

$tokens_get = "UPDATE `tokens` SET `isburned` = 'yes' WHERE value = '" .  $token . "'";
$tokenrlt = $dbc->query($tokens_get);

    if (isset($tokenrlt)){
		return true;           
	} 
    else{     
		return false;
    }
}

	


require_once("footer.php");
?>