<?php require_once("mysqli_connect.php");

include 'header.php';


if (isset($_GET['token'])){
	if (preg_match('/^\{?[A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}\}?$/', $_GET['token'])){

		echo '
<h2>Add User</h2>

		<form action="' . $_SERVER['PHP_SELF'] . '" method="post" enctype="multipart/form-data";>
			<table class="submit";>
								
				<tr>
					<td>Username:</td>
					<td><input type=text name="username" value=""></input></td>
				</tr>
				<tr>
					<td>Email:</td>
					<td><input type=text name="email" value=""></input></td>
				</tr>
				<tr>
					<td>Password:</td>
					<td><input type=text name="password" value=""></input></td>
				</tr>
				<tr>
					<td>Confirm Password:</td>
					<td><input type=text name="password2" value=""></input></td>
				</tr>

				<tr>
					<td colspan="2">
						<input type="hidden" name="token" value="' . $_GET['token'] . '">
						<input type="submit" value="Submit" />
					</td>
					
				</tr>
			</table>
		</form>
';
	}
	else{
		echo "not a valid token";
	}
}
else{
	if (!isset($_POST['token'])){
		echo 'please email an admin to request a registration token and someone will verify your request shortly: <a HREF="mailto:webmaster@example.com?subject=CTF registration request&body=gimme one">gimme one</a>';
	}
}



if (isset($_POST['token'])){
	//copy = "INSERT INTO table (a, b, c) VALUES (NOW(),now() + interval 14 day, $var_for_c)";
	//SELECT completed, completed + interval 14 day FROM pwns

	if (preg_match('/^\{?[A-Z0-9]{8}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{12}\}?$/', $_POST['token'])){
	 //if (1 == 354){

		 if ($stmt = $dbc->prepare("SELECT * FROM tokens WHERE value = ? AND page = 'adduser.php' AND isburned = 'no' AND expires > NOW()")) {
		        
		        $stmt->bind_param('s', $_POST['token']);
		        $stmt->execute();   // Execute the prepared query.
		        $stmt->store_result();


		       if ($stmt->num_rows == 1) {
		            // If some labs exists get variables from result.
		            checkinput($dbc);
		        }
		        else{
		        	echo 'no';
		        }
		        
		}
		else {
		    return false;
		}
    }
    else {
        return 'database error';
    }
}




function checkinput($dbc){
				if (isset($_POST['email']) && isset($_POST['password']) && isset($_POST['password2'])){
            		$username = $_POST['username'];
					$email = $_POST['email'];
					$password = $_POST['password'];
					$password2 = $_POST['password2'];

					if($password == $password2){

						if (burntoken($dbc, $_POST['token'])){
							add_user($dbc, $username, $password, $email);
						}

					}
					else{
						echo 'Error: Passwords do not match';
					}


					//	if (strlen($username) < 4 || strlen($username) > 30{
					//	
					//	err ++;
					//	echo 'username must be between 4 and 30 characters';
					//	}
				}    	
		    	else{
		    		echo "missing data";
		    	}
		    }
	    

function add_user($dbc, $u, $p, $e ) {
 
      $query = "INSERT INTO `users` (`userID`, `username`, `password`, `email`) VALUES (NULL, ?, ?, ?)";

        $stmt = mysqli_prepare($dbc, $query);

        mysqli_stmt_bind_param($stmt, 'sss', $u, md5($p), $e);

        mysqli_stmt_execute($stmt);
     
        $affected_rows = mysqli_stmt_affected_rows($stmt);

            if($affected_rows == 1){
                 
                echo 'User successfully added';
                //mysqli_stmt_close($stmt);
                //mysqli_close($dbc);
                
            } 
            else{     
                echo 'Error occurred';
                echo mysqli_error($dbc);
                //mysqli_stmt_close($stmt);
                //mysqli_close($dbc);
               
            }
}

function burntoken($dbc, $token){

$tokens_get = "UPDATE `tokens` SET `isburned` = 'yes' WHERE value = '" .  $token . "'";
$tokenrlt = $dbc->query($tokens_get);

    if (isset($tokenrlt)){
		return true;           
	} 
    else{     
		return false;
    }
}

	


require_once("footer.php");
?>