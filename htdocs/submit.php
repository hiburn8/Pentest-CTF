<?php 


session_start();

if (!isset($_SESSION["username"])){
    $_SESSION["redirectURL"] = "submit.php";
    header('Location: auth.php');
    die();
}

require_once("mysqli_connect.php");
require_once('header.php');

$_POST = array_map('stripslashes', $_POST);

/* function isitarealflag($mysqli, $f) {
        if ($stmt = $mysqli->prepare("SELECT flag  FROM `labs` where flag = ?")) {
            
            $stmt->bind_param('s', $f);
            $stmt->execute();   
            $stmt->store_result();
 
            if ($stmt->num_rows == 1) {
                    return true;
                } 
                else {
                    echo htmlEntities($f . 'is not a flag', ENT_QUOTES);
                    return false;
            }
        }
}*/


function doihavethisflag($mysqli, $u, $f) {
        if ($stmt = $mysqli->prepare("SELECT labs.flag  FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID WHERE users.username = ? AND labs.flag = ?")) {
            
            $stmt->bind_param('ss', $u, $f);
            $stmt->execute();  
            $stmt->store_result();
 
           if ($stmt->num_rows == 1) {
                return true;
            }
            elseif ($stmt->num_rows > 1) {
                echo 'you already have this flag more than once somehow :S';
                return true;
            }
            else {
                return false;
            }
    }
    else {
        return 'database error';
    }
}

function isthismylab($mysqli, $author, $f) {
        if ($stmt = $mysqli->prepare("SELECT authorID FROM labs WHERE authorID = ? AND flag = ?")) {
            
            $stmt->bind_param('ss', $author, $f);
            $stmt->execute(); 
            $stmt->store_result();

           if ($stmt->num_rows == 1) {
                return true;
            }
            elseif ($stmt->num_rows > 1) {
                echo 'Error: this is very fishy! ';
                return true;
            }
            else {
                return false;
            }
    }
    else {
        return 'database error';
    }
}


function checkflagisrealandsubmitpwn($mysqli, $u, $f) {
    if ($stmt = $mysqli->prepare("select labID from labs where flag = ? UNION ALL select userID from users where username = ?")) {

        $stmt->bind_param('ss', $f,$u);
        $stmt->execute();   
        $stmt->store_result();

        if ($stmt->num_rows == 2) {

        	$stmt->bind_result($data);

           	for($i = 0; ($stmt->fetch()); $i++){
                //get lab and user IDs
           		if ($i == 0){
           			$labID = $data;
                    //echo $labID;
           		}
           		elseif ($i == 1) {
           			$userID = $data;
                    //echo $userID;
           		}   		
            }
            //echo '<br>' . $labID . '~' .  $userID . '<br>';
            if ($stmt = $mysqli->prepare("INSERT INTO `pwns` (`labID`, `userID`) VALUES (?, ?)")) {
        
                $stmt->bind_param('ss', $labID,$userID);
                $stmt->execute(); 
                return true;
            }
        }
        
    }
    else{
        echo 'database error';
    }
}

if (isset($_POST['flag'])){

    //$escFlag = mysqli_real_escape_string($dbc, $_POST['flag']);
    $escFlag = $_POST['flag'];

    if (doihavethisflag($dbc, $_SESSION["username"], $escFlag)){
        echo 'Sorry, you have already submitted that flag';
    }
    
    elseif (isthismylab($dbc, $_SESSION["userID"], $escFlag)) {
        echo 'That flag is for a lab created by you, silly. But at least it works!';
    }
    elseif (checkflagisrealandsubmitpwn($dbc, $_SESSION["username"], $escFlag)) {
		echo 'Congratulations, flag successfully added!';
   }
   else{
        //echo 'Sorry, ' . $escFlag . ' is not a flag';
        echo 'Sorry, "' . htmlEntities($escFlag, ENT_QUOTES) . '" is not a flag';
   }
}


?>
	<h2>Submit</h2>

		<form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post" enctype="multipart/form-data";>
			<table class="submit";>			
				<tr>
					<td>Enter flag:</td>
					<td><input type=text name="flag" autocomplete="off"></input></td>
				</tr>
				<tr>
					<td colspan="2">
						<input type="submit" value="Submit" />
					</td>
				</tr>
			</table>
		</form>

<?php include 'footer.php';?>