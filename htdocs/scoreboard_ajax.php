<?php

session_start();
require_once("mysqli_connect.php");
require_once('functions.php');

$flags = 0;
$badges = '';

function onlinestatus($username){
	if (isset($_SESSION["username"]) && $_SESSION["username"] == $username){
	    return '<img src="badges/status_online.png" title="you are online">';
	}
}

function top3orlast($pos, $flags, $rows){

	$badges = '';

	if (isset($_SESSION["position"])){

		if ($pos < $_SESSION["position"]){
	    	$badges .= '<img src="badges/bullet_arrow_down.png">';
		}
		elseif ($pos > $_SESSION["position"]){
	    	$badges .= '<img src="badges/bullet_arrow_up.png">';
		}
		else{
			$_SESSION["position"] = $pos;
		}
	}
	switch ($pos) {
	    case 1: $badges .= '<img src="badges/award_star_gold_1.png" title="you are 1st!">'; break;
	    case 2: $badges .= '<img src="badges/award_star_silver_2.png" title="you are 2nd!">'; break;
	    case 3: $badges .= '<img src="badges/award_star_bronze_3.png" title="you are 3rd!">'; break;
	}
	switch ($flags) {
	    case 1:
	        $badges .= '<img src="badges/rosette.png" title="you earned your first flag!">';
	        break;
	}
	if ($pos == $rows){
			$badges .= '<img src="badges/poop-emoticon.png" title="oh dear. youre last">';
	}
	//echo $flags;
	if (!empty($badges)){
		return $badges;
	}
}

//$userdata_get = "SELECT users.username, COUNT(users.username) as count, users.points FROM `pwns` INNER JOIN users ON users.userID=pwns.userID GROUP BY username ORDER BY users.points DESC";

$userdata_get = "SELECT users.username, users.userID, COUNT(pwns.userID) AS flags, SUM(labs.difficulty) as sumDifficulty, registered FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID GROUP BY pwns.userID ORDER BY sumDifficulty DESC, flags DESC, users.registered DESC, username";
$usrrlt = $dbc->query($userdata_get);
?>


<?php
       
$pos = 1;
while( $row = $usrrlt->fetch_assoc()){
	echo '<tr>';
	echo '<td>' . $pos . top3orlast($pos, $row["flags"], $usrrlt->num_rows) . '</td>';
	echo '<td><a href="user.php?id=' . $row["userID"] . '">' . $row["username"] . '</a>' . onlinestatus($row["username"]) . '</td>';
	echo '<td>' . $row["sumDifficulty"] .'</td>';
	echo '<td>' . $row["flags"] . '</td>';
	echo '<td>' . timeBetween(strtotime($row["registered"]),-1) . ' ago' . '</td>';
	echo '</tr>';
$pos += 1;
}

?>



<?php
/*function getscoredata($dbc){

$userdata_get = "SELECT users.username, COUNT(pwns.userID) AS flags, SUM(labs.difficulty) as sumDifficulty, registered FROM `pwns` INNER JOIN labs ON labs.labID=pwns.labID INNER JOIN users on users.userID=pwns.userID GROUP BY pwns.userID ORDER BY sumDifficulty DESC";
$usrrlt = $dbc->query($userdata_get);
$pos = 1;
while( $row = $usrrlt->fetch_assoc()){

	echo "['" . $pos . "', '" . $row["username"] . "' , '" . timeBetween(strtotime($row["registered"]),-1) . "' , '" . $row["flags"] . "' , '" . $row["sumDifficulty"] . "'],";
	$pos += 1;
}
}*/
?>
